<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<title>–°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<!-- /Firebase SDK -->

<style>
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: scale(0.8) rotate(-5deg);
    }
    to {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }
  }

  @keyframes pulse {
    0%, 100% {
      transform: scale(1);
      opacity: 1;
    }
    50% {
      transform: scale(1.05);
      opacity: 0.7;
    }
  }

  @keyframes rotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .qr-new {
    animation: fadeIn 0.6s ease-out;
  }

  .pulse-warning {
    animation: pulse 1.5s infinite;
  }

  .loading-spinner {
    animation: rotate 1s linear infinite;
  }

  #qr-container {
    min-height: 256px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .timer-circle {
    transform: rotateY(180deg) rotateZ(-90deg);
  }

  .timer-circle-bg {
    stroke: #e5e7eb;
    stroke-width: 8;
    fill: none;
  }

  .timer-circle-progress {
    stroke-dasharray: 377;
    stroke-dashoffset: 0;
    stroke-linecap: round;
    stroke-width: 8;
    fill: none;
    transition: stroke-dashoffset 0.5s linear;
  }
</style>
</head>
<body>
<div id="app"></div>

<script>
(() => {
  'use strict';

  // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
  const CONFIG = {
    TOKEN_LIFETIME: 3 * 60 * 1000, // 3 –º–∏–Ω—É—Ç—ã
    AUTO_REFRESH: true,
    TIMER_UPDATE_INTERVAL: 250, // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ 4 —Ä–∞–∑–∞ –≤ —Å–µ–∫—É–Ω–¥—É
    DEBUG: true // –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  };

  // ==================== Firebase –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ====================
  // !!! –í–ê–ñ–ù–û: –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –ù–ê –í–ê–®–ò –†–ï–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï –ò–ó –ö–û–ù–°–û–õ–ò FIREBASE !!!
  const firebaseConfig = {
    apiKey: "AIzaSyDYnHchI8ozY2dTe4bt_qcGgo9p1VdwPws",
    authDomain: "sc-attendance-system.firebaseapp.com",
    projectId: "sc-attendance-system",
    storageBucket: "sc-attendance-system.firebasestorage.app",
    messagingSenderId: "524269299204",
    appId: "1:524269299204:web:b2a53dc417286065c77751"
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // –°—Å—ã–ª–∫–∏ –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ Firestore
  const allowedPeopleCol = db.collection('allowedPeople');
  const attendanceCol = db.collection('attendance');
  const usedTokensCol = db.collection('usedTokens');
  // ==================== /Firebase –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ====================

  // ==================== –£–¢–ò–õ–ò–¢–´ ====================

  const log = (...args) => {
    if (CONFIG.DEBUG) console.log('[QR System]', ...args);
  };

  const error = (...args) => {
    console.error('[QR System Error]', ...args);
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–≥–æ URL
  function getBaseUrl() {
    // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏–ª–∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
    if (window.location.protocol === 'file:') {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π IP –∏–ª–∏ localhost
      return 'https://pd-attendance-system.vercel.app'; // –ü—Ä–∏–º–µ—Ä, –∏–∑–º–µ–Ω–∏—Ç–µ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    }

    const { protocol, hostname, port, pathname } = window.location;
    let url = `${protocol}//${hostname}`;
    if (port) url += `:${port}`;
    url += pathname;
    return url;
  }

  // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ù–ï–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (Firebase –±—É–¥–µ—Ç –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)
  const localCache = {
    set(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
        return true;
      } catch (e) {
        error('Local cache set error:', e);
        return false;
      }
    },

    get(key, defaultValue = null) {
      try {
        const item = localStorage.getItem(key);
        return item ? JSON.parse(item) : defaultValue;
      } catch (e) {
        error('Local cache get error:', e);
        return defaultValue;
      }
    },

    remove(key) {
      try {
        localStorage.removeItem(key);
        return true;
      } catch (e) {
        error('Local cache remove error:', e);
        return false;
      }
    }
  };

  // ==================== –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================

  const state = {
    // –î–∞–Ω–Ω—ã–µ: —Ç–µ–ø–µ—Ä—å –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∏–∑ Firebase
    allowedPeople: [], // { id, name }
    attendance: [],
    usedTokens: [],

    // –¢–µ–∫—É—â–∏–π —Ç–æ–∫–µ–Ω (–±—É–¥–µ—Ç –≤ localCache)
    currentToken: localCache.get('currentToken', null),
    tokenExpiry: localCache.get('tokenExpiry', null),

    // UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    currentView: 'loading',

    // –¢–∞–π–º–µ—Ä—ã
    autoRefreshTimer: null,
    countdownTimer: null,

    // QR –æ–±—ä–µ–∫—Ç
    qrCode: null,

    // Firebase Listeners
    allowedPeopleListener: null,
    attendanceListener: null,
    usedTokensListener: null
  };

  // ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –¢–û–ö–ï–ù–ê–ú–ò ====================

  class TokenManager {
    static generate() {
      const timestamp = Date.now();
      const random1 = Math.random().toString(36).substring(2, 10);
      const random2 = Math.random().toString(36).substring(2, 10);
      const token = `${timestamp}-${random1}-${random2}`;

      log('Generated token:', token);
      return token;
    }

    static create() {
      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ç–∞–π–º–µ—Ä—ã
      this.clearTimers();

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω
      state.currentToken = this.generate();
      state.tokenExpiry = Date.now() + CONFIG.TOKEN_LIFETIME;

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
      localCache.set('currentToken', state.currentToken);
      localCache.set('tokenExpiry', state.tokenExpiry);

      log('Token created, expires:', new Date(state.tokenExpiry).toLocaleTimeString());

      // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä—ã
      this.startTimers();

      return state.currentToken;
    }

    static clearTimers() {
      if (state.autoRefreshTimer) {
        clearTimeout(state.autoRefreshTimer);
        state.autoRefreshTimer = null;
      }
      if (state.countdownTimer) {
        clearInterval(state.countdownTimer);
        state.countdownTimer = null;
      }
    }

    static startTimers() {
      // –¢–∞–π–º–µ—Ä –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –æ—Ç—Å—á–µ—Ç–∞
      state.countdownTimer = setInterval(() => {
        this.updateTimer();
      }, CONFIG.TIMER_UPDATE_INTERVAL);

      // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      if (CONFIG.AUTO_REFRESH) {
        state.autoRefreshTimer = setTimeout(() => {
          if (state.currentView === 'admin') {
            log('Auto-refresh triggered');
            this.create();
            UI.updateQRCode();
          }
        }, CONFIG.TOKEN_LIFETIME);
      }
    }

    static updateTimer() {
      if (!state.tokenExpiry) return;

      const remaining = Math.max(0, state.tokenExpiry - Date.now());
      const percentage = remaining / CONFIG.TOKEN_LIFETIME;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Ç–∞–π–º–µ—Ä–∞
      const timerText = document.getElementById('timer-text');
      if (timerText) {
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        timerText.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç
        timerText.className = 'text-3xl font-bold transition-colors ';
        if (remaining < 30000) {
          timerText.className += 'text-red-600 pulse-warning';
        } else if (remaining < 60000) {
          timerText.className += 'text-orange-600';
        } else {
          timerText.className += 'text-green-600';
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
      const progressBar = document.getElementById('timer-bar');
      if (progressBar) {
        progressBar.style.width = `${percentage * 100}%`;
        progressBar.className = 'h-full transition-all duration-300 ';
        if (remaining < 30000) {
          progressBar.className += 'bg-red-500';
        } else if (remaining < 60000) {
          progressBar.className += 'bg-orange-500';
        } else {
          progressBar.className += 'bg-green-500';
        }
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –∫—Ä—É–≥
      const circle = document.getElementById('timer-circle');
      if (circle) {
        const circumference = 377; // 2 * PI * 60
        const offset = circumference * (1 - percentage);
        circle.style.strokeDashoffset = offset;

        if (remaining < 30000) {
          circle.style.stroke = '#ef4444';
        } else if (remaining < 60000) {
          circle.style.stroke = '#f97316';
        } else {
          circle.style.stroke = '#10b981';
        }
      }

      // –ï—Å–ª–∏ –≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ
      if (remaining === 0 && state.currentView === 'admin' && !CONFIG.AUTO_REFRESH) {
        this.clearTimers();
        UI.showExpiredState();
      }
    }

    static async validate(token) {
      if (!token) return false;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ª–∏ –∏–∑ Firebase
      const usedTokenDoc = await usedTokensCol.doc(token).get();
      if (usedTokenDoc.exists) {
        log('Token already used:', token);
        return false;
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
      try {
        const timestamp = parseInt(token.split('-')[0]);
        const age = Date.now() - timestamp;

        if (age > CONFIG.TOKEN_LIFETIME) {
          log('Token expired. Age:', Math.floor(age / 1000), 'seconds');
          return false;
        }

        log('Token valid');
        return true;
      } catch (e) {
        error('Token validation error:', e);
        return false;
      }
    }

    static async markAsUsed(token) {
      try {
        await usedTokensCol.doc(token).set({ timestamp: Date.now() });
        log('Token marked as used in Firebase');
        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –±–∞—Ç—á–µ–º –∏–ª–∏ Cloud Function)
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –≤ —ç—Ç–æ–º –ø—Ä–∏–º–µ—Ä–µ, –æ—á–∏—Å—Ç–∫–∞ –±—É–¥–µ—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ state.usedTokens
      } catch (e) {
        error('Failed to mark token as used:', e);
        UI.showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', 'error');
      }
    }
  }

  // ==================== UI –£–ü–†–ê–í–õ–ï–ù–ò–ï ====================

  const UI = {
    showNotification(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-orange-500',
        info: 'bg-blue-500'
      };

      const notification = document.createElement('div');
      notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50
                                transform translate-x-96 transition-transform duration-300 ${colors[type]}`;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.classList.remove('translate-x-96');
      }, 100);

      setTimeout(() => {
        notification.classList.add('translate-x-96');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    },

    updateQRCode() {
      const container = document.getElementById('qr-container');
      if (!container || !state.currentToken) return;

      const baseUrl = getBaseUrl();
      const qrUrl = `${baseUrl}?t=${state.currentToken}`;

      log('Generating QR for:', qrUrl);

      // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      container.innerHTML = '';

      // –°–æ–∑–¥–∞–µ–º div –¥–ª—è QR
      const qrDiv = document.createElement('div');
      qrDiv.className = 'qr-new';
      container.appendChild(qrDiv);

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR
      try {
        state.qrCode = new QRCode(qrDiv, {
          text: qrUrl,
          width: 256,
          height: 256,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });

        log('QR code generated successfully');
      } catch (e) {
        error('QR generation failed:', e);
        container.innerHTML = '<p class="text-red-600">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR</p>';
      }
    },

    showExpiredState() {
      const container = document.getElementById('qr-status');
      if (container) {
        container.innerHTML = `
          <div class="text-center py-8">
            <div class="text-6xl mb-4">‚è∞</div>
            <p class="text-xl text-red-600 font-bold mb-4">QR-–∫–æ–¥ –∏—Å—Ç—ë–∫</p>
            <button onclick="App.refreshToken()"
                    class="px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white
                           rounded-lg hover:shadow-lg transition-all transform hover:scale-105">
              üîÑ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π QR
            </button>
          </div>
        `;
      }
    }
  };

  // ==================== –ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê ====================

  const App = {
    async loadExcelFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

          const newAllowedPeople = [];
          const batch = db.batch();

          // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö
          const oldDocs = await allowedPeopleCol.get();
          oldDocs.forEach(doc => {
            batch.delete(doc.ref);
          });

          // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - ID, –≤—Ç–æ—Ä–∞—è - –§–ò–û
          for (let i = 1; i < jsonData.length; i++) { // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const row = jsonData[i];
            if (row[0] && row[1]) { // –û–±–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
              const personData = {
                id: row[0].toString().trim(),
                name: row[1].toString().trim()
              };
              newAllowedPeople.push(personData);
              batch.set(allowedPeopleCol.doc(personData.id), personData); // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID –∫–∞–∫ document ID
            }
          }

          await batch.commit(); // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–∞—Ç—á–∞
          UI.showNotification(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${newAllowedPeople.length} —Å—Ç—É–¥–µ–Ω—Ç–æ–≤ –≤ Firebase`, 'success');
          // state.allowedPeople –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω —á–µ—Ä–µ–∑ onSnapshot
          // Render.view() –≤—ã–∑–æ–≤–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è state.allowedPeople
        } catch (err) {
          error('Excel parsing or Firebase upload error:', err);
          UI.showNotification('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ Firebase. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç: "ID | –§–ò–û" –∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ Firebase.', 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    },

    async registerAttendance() {
      const isNotRegistered = document.getElementById('notRegisteredCheckbox')?.checked;
      let personName = '';
      let isValidEntry = false;
      let personId = 'guest_' + Date.now(); // –î–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º ID

      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('t');

      if (!token) {
        UI.showNotification('‚ùå –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
        return;
      }

      const tokenValid = await TokenManager.validate(token);
      if (!tokenValid) {
        UI.showNotification('‚ùå QR-–∫–æ–¥ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω', 'error');
        setTimeout(() => {
          window.location.href = window.location.pathname;
        }, 2000);
        return;
      }

      if (isNotRegistered) {
        const nameInput = document.getElementById('nameInput');
        personName = nameInput.value.trim();
        if (!personName) {
          UI.showNotification('–í–≤–µ–¥–∏—Ç–µ –§–ò–û', 'warning');
          return;
        }
        isValidEntry = true;
        personId = `guest_${personName.replace(/\s+/g, '_')}_${Date.now()}`; // –ë–æ–ª–µ–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≥–æ—Å—Ç–µ–π
      } else {
        const idInput = document.getElementById('uniqueIdInput');
        const uniqueId = idInput.value.trim();
        if (!uniqueId) {
          UI.showNotification('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID', 'warning');
          return;
        }

        const foundPerson = state.allowedPeople.find(person => person.id === uniqueId);

        if (!foundPerson) {
          UI.showNotification('‚ùå –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ', 'error');
          return;
        }
        personName = foundPerson.name;
        personId = foundPerson.id;
        isValidEntry = true;
      }

      if (!isValidEntry) return;

      const today = new Date().toLocaleDateString('ru-RU');

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–º–µ—Ç–∫–∏ (–ø–æ –§–ò–û –∏ –¥–∞—Ç–µ) –∏–∑ Firebase
      const existingAttendanceQuery = await attendanceCol
        .where('name', '==', personName)
        .where('date', '==', today)
        .get();

      if (!existingAttendanceQuery.empty) {
        UI.showNotification(`‚ö†Ô∏è ${personName} —É–∂–µ –æ—Ç–º–µ—á–µ–Ω(–∞) —Å–µ–≥–æ–¥–Ω—è`, 'warning');
        return;
      }

      // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ Firebase
      try {
        await attendanceCol.add({
          personId: personId, // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID, –µ—Å–ª–∏ –µ—Å—Ç—å
          name: personName,
          date: today,
          time: new Date().toLocaleTimeString('ru-RU'),
          timestamp: Date.now()
        });
        await TokenManager.markAsUsed(token); // –û—Ç–º–µ—á–∞–µ–º —Ç–æ–∫–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–º –≤ Firebase

        state.currentView = 'success';
        Render.view();

        setTimeout(() => {
          window.location.href = window.location.pathname;
        }, 3000);
      } catch (e) {
        error('Failed to register attendance:', e);
        UI.showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ—Å–µ—â–µ–Ω–∏—è', 'error');
      }
    },

    async exportToExcel() {
      // –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–∂–µ –≤ state.attendance –±–ª–∞–≥–æ–¥–∞—Ä—è onSnapshot
      const data = [['‚Ññ', '–§–ò–û', '–î–∞—Ç–∞', '–í—Ä–µ–º—è']];
      state.attendance.forEach((entry, i) => {
        data.push([i + 1, entry.name, entry.date, entry.time]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, '–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å');

      const date = new Date().toLocaleDateString('ru-RU').replace(/\./g, '-');
      XLSX.writeFile(wb, `attendance_${date}.xlsx`);
      UI.showNotification('‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
    },

    async clearAttendance() {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∏ –æ –ø–æ—Å–µ—â–µ–Ω–∏–∏? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
        try {
          const querySnapshot = await attendanceCol.get();
          const batch = db.batch();
          querySnapshot.forEach(doc => {
            batch.delete(doc.ref);
          });
          await batch.commit();

          // –û—á–∏—â–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã —Ç–æ–∂–µ, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ –ø–æ—Å–µ—â–µ–Ω–∏—è–º
          const tokensSnapshot = await usedTokensCol.get();
          const tokenBatch = db.batch();
          tokensSnapshot.forEach(doc => {
            tokenBatch.delete(doc.ref);
          });
          await tokenBatch.commit();

          UI.showNotification('‚úÖ –ñ—É—Ä–Ω–∞–ª –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –æ—á–∏—â–µ–Ω—ã –≤ Firebase', 'success');
          // state.attendance –∏ state.usedTokens –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ onSnapshot
          // Render.view() –≤—ã–∑–æ–≤–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è state.attendance
        } catch (e) {
          error('Failed to clear attendance:', e);
          UI.showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∂—É—Ä–Ω–∞–ª–∞', 'error');
        }
      }
    },

    refreshToken() {
      TokenManager.create();
      UI.updateQRCode();
      UI.showNotification('‚úÖ QR-–∫–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
      Render.adminView();
    },

    showView(view) {
      state.currentView = view;
      Render.view();
    }
  };

  // ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================

  const Render = {
    adminView() {
      const hasToken = state.currentToken && state.tokenExpiry > Date.now();

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 p-4">
          <div class="max-w-7xl mx-auto">
            <h1 class="text-4xl md:text-5xl font-bold text-white text-center mb-8 drop-shadow-lg">
              üéØ –°–∏—Å—Ç–µ–º–∞ —É—á—ë—Ç–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
            </h1>

            <div class="grid md:grid-cols-2 gap-6">
              <!-- QR Panel -->
              <div class="bg-white rounded-2xl shadow-2xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                  QR-–∫–æ–¥ –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏
                </h2>

                <div id="qr-status">
                  ${hasToken ? `
                    <div class="text-center">
                      <!-- QR Container -->
                      <div class="inline-block p-4 bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl mb-6">
                        <div id="qr-container"></div>
                      </div>

                      <!-- Timer Circle -->
                      <div class="relative inline-block mb-4">
                        <svg class="timer-circle w-32 h-32">
                          <circle class="timer-circle-bg" cx="64" cy="64" r="60" />
                          <circle id="timer-circle" class="timer-circle-progress"
                                  cx="64" cy="64" r="60" stroke="#10b981" />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                          <span id="timer-text" class="text-3xl font-bold text-green-600">3:00</span>
                        </div>
                      </div>

                      <!-- Progress Bar -->
                      <div class="w-full bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                        <div id="timer-bar" class="h-full bg-green-500" style="width: 100%"></div>
                      </div>

                      <!-- Refresh Button -->
                      <button onclick="App.refreshToken()"
                              class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600
                                     text-white rounded-lg hover:shadow-lg transition-all
                                     transform hover:scale-105 font-semibold">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å QR-–∫–æ–¥
                      </button>

                      <p class="text-xs text-gray-500 mt-2">
                        –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 3 –º–∏–Ω—É—Ç—ã
                      </p>
                    </div>
                  ` : `
                    <div class="text-center py-8">
                      <div class="text-6xl mb-4">üì±</div>
                      <p class="text-gray-600 mb-4">QR-–∫–æ–¥ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</p>
                      <button onclick="App.refreshToken()"
                              class="px-8 py-4 bg-gradient-to-r from-green-600 to-emerald-600
                                     text-white rounded-lg hover:shadow-lg transition-all
                                     transform hover:scale-105 text-lg font-semibold">
                        ‚ú® –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥
                      </button>
                    </div>
                  `}
                </div>
              </div>

              <!-- Control Panel -->
              <div class="bg-white rounded-2xl shadow-2xl p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                  –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                </h2>

                <div class="space-y-4">
                  <div>
                    <label class="block text-gray-700 font-medium mb-2">
                      üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ (Excel: "ID | –§–ò–û")
                    </label>
                    <input type="file" accept=".xlsx,.xls" onchange="App.loadExcelFile(event)"
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg
                                  cursor-pointer hover:border-purple-500 transition" />
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg">
                      <p class="text-3xl font-bold text-blue-600">${state.allowedPeople.length}</p>
                      <p class="text-sm text-gray-600">–í—Å–µ–≥–æ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg">
                      <p class="text-3xl font-bold text-green-600">${state.attendance.length}</p>
                      <p class="text-sm text-gray-600">–û—Ç–º–µ—á–µ–Ω–æ</p>
                    </div>
                  </div>

                  <div class="space-y-2">
                    <button onclick="App.showView('journal')"
                            class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg
                                   hover:bg-purple-700 transition-all">
                      üìã –û—Ç–∫—Ä—ã—Ç—å –∂—É—Ä–Ω–∞–ª
                    </button>

                    ${state.attendance.length > 0 ? `
                      <button onclick="App.exportToExcel()"
                              class="w-full px-6 py-3 bg-green-600 text-white rounded-lg
                                     hover:bg-green-700 transition-all">
                        üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                      </button>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>

            ${state.attendance.length > 0 ? `
              <div class="bg-white rounded-2xl shadow-2xl p-6 mt-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–º–µ—Ç–∫–∏</h3>
                <div class="space-y-2">
                  ${state.attendance.slice(-5).reverse().map(entry => `
                    <div class="flex justify-between items-center p-3
                                bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                      <span class="font-medium text-gray-800">${entry.name}</span>
                      <div class="text-right">
                        <span class="text-sm text-gray-600">${entry.time}</span>
                        <span class="text-xs text-gray-500 block">${entry.date}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
      if (hasToken) {
        setTimeout(() => {
          UI.updateQRCode();
          TokenManager.updateTimer();
        }, 100);
      }
    },

    registerView() {
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get('t');

      // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: validate —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ App.registerAttendance
      // –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ –∑–¥–µ—Å—å
      // –î–æ–±–∞–≤–∏–º —Å–ø–∏–Ω–Ω–µ—Ä –∏–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ, –ø–æ–∫–∞ –Ω–µ –±—É–¥–µ—Ç —è—Å–Ω–æ, —á—Ç–æ —Å —Ç–æ–∫–µ–Ω–æ–º

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600
                    flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r
                       from-blue-600 to-purple-600 text-transparent bg-clip-text">
              –û—Ç–º–µ—Ç–∫–∞ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏
            </h2>

            <div class="mb-4" id="id-input-group">
              <label class="block text-gray-700 font-medium mb-2">
                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID:
              </label>
              <input id="uniqueIdInput" type="text"
                     placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 12345"
                     class="w-full px-4 py-3 rounded-lg border-2 border-gray-300
                            focus:border-purple-500 focus:outline-none transition" />
            </div>

            <div class="mb-4 hidden" id="name-input-group">
              <label class="block text-gray-700 font-medium mb-2">
                –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û:
              </label>
              <input id="nameInput" type="text"
                     placeholder="–§–∞–º–∏–ª–∏—è –ò–º—è –û—Ç—á–µ—Å—Ç–≤–æ"
                     class="w-full px-4 py-3 rounded-lg border-2 border-gray-300
                            focus:border-purple-500 focus:outline-none transition" disabled />
            </div>

            <div class="mb-6 flex items-center">
              <input type="checkbox" id="notRegisteredCheckbox" class="h-4 w-4 text-purple-600
                                                         focus:ring-purple-500 border-gray-300 rounded">
              <label for="notRegisteredCheckbox" class="ml-2 text-gray-700">
                –Ø –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω(–∞)
              </label>
            </div>

            <button onclick="App.registerAttendance()"
                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600
                           text-white py-3 rounded-lg font-semibold
                           hover:shadow-lg transition-all transform hover:scale-105">
              ‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å—Å—è
            </button>
          </div>
        </div>
      `;

      const notRegisteredCheckbox = document.getElementById('notRegisteredCheckbox');
      const idInputGroup = document.getElementById('id-input-group');
      const uniqueIdInput = document.getElementById('uniqueIdInput');
      const nameInputGroup = document.getElementById('name-input-group');
      const nameInput = document.getElementById('nameInput');

      notRegisteredCheckbox.addEventListener('change', (event) => {
        if (event.target.checked) {
          idInputGroup.classList.add('hidden');
          uniqueIdInput.disabled = true;
          uniqueIdInput.value = ''; // –û—á–∏—â–∞–µ–º ID
          nameInputGroup.classList.remove('hidden');
          nameInput.disabled = false;
          nameInput.focus();
        } else {
          idInputGroup.classList.remove('hidden');
          uniqueIdInput.disabled = false;
          uniqueIdInput.focus();
          nameInputGroup.classList.add('hidden');
          nameInput.disabled = true;
          nameInput.value = ''; // –û—á–∏—â–∞–µ–º –§–ò–û
        }
      });

      // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ ID –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      setTimeout(() => {
        uniqueIdInput?.focus();
      }, 100);
    },

    successView() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-green-500 to-emerald-600
                    flex items-center justify-center p-4">
          <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-md">
            <div class="text-7xl mb-4 animate-bounce">‚úÖ</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">–£—Å–ø–µ—à–Ω–æ!</h2>
            <p class="text-xl text-gray-600">–ü–æ—Å–µ—â–µ–Ω–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ</p>
            <p class="text-sm text-gray-500 mt-4">–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ...</p>
          </div>
        </div>
      `;
    },

    journalView() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-gray-100 to-gray-200 p-4">
          <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">üìã –ñ—É—Ä–Ω–∞–ª</h2>
                <button onclick="App.showView('admin')"
                        class="px-4 py-2 bg-gray-600 text-white rounded-lg
                               hover:bg-gray-700 transition">
                  ‚Üê –ù–∞–∑–∞–¥
                </button>
              </div>

              ${state.attendance.length === 0 ? `
                <p class="text-gray-600 text-center py-12">–ü—É—Å—Ç–æ</p>
              ` : `
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="bg-gradient-to-r from-blue-600 to-purple-600 text-white">
                        <th class="py-3 px-4 text-left">‚Ññ</th>
                        <th class="py-3 px-4 text-left">–§–ò–û</th>
                        <th class="py-3 px-4 text-left">–î–∞—Ç–∞</th>
                        <th class="py-3 px-4 text-left">–í—Ä–µ–º—è</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${state.attendance.map((entry, i) => `
                        <tr class="${i % 2 === 0 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50">
                          <td class="py-2 px-4">${i + 1}</td>
                          <td class="py-2 px-4 font-medium">${entry.name}</td>
                          <td class="py-2 px-4">${entry.date}</td>
                          <td class="py-2 px-4">${entry.time}</td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>

                <div class="mt-6 flex gap-4">
                  <button onclick="App.exportToExcel()"
                          class="px-6 py-3 bg-green-600 text-white rounded-lg
                                 hover:bg-green-700 transition">
                    üíæ –≠–∫—Å–ø–æ—Ä—Ç
                  </button>
                  <button onclick="App.clearAttendance()"
                          class="px-6 py-3 bg-red-600 text-white rounded-lg
                                 hover:bg-red-700 transition">
                    üóë –û—á–∏—Å—Ç–∏—Ç—å
                  </button>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    },

    view() {
      switch(state.currentView) {
        case 'admin':
          this.adminView();
          break;
        case 'register':
          this.registerView();
          break;
        case 'success':
          this.successView();
          break;
        case 'journal':
          this.journalView();
          break;
        default:
          this.adminView();
      }
    }
  };

  // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================

  async function init() {
    log('Initializing...');

    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö Firebase –¥–ª—è Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
    state.allowedPeopleListener = allowedPeopleCol.onSnapshot(snapshot => {
      state.allowedPeople = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      log('Allowed people updated from Firebase:', state.allowedPeople.length);
      if (state.currentView === 'admin') Render.view(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
    }, error);

    state.attendanceListener = attendanceCol.orderBy('timestamp', 'desc').onSnapshot(snapshot => {
      state.attendance = snapshot.docs.map(doc => ({ firebaseId: doc.id, ...doc.data() }));
      log('Attendance updated from Firebase:', state.attendance.length);
      if (state.currentView === 'admin' || state.currentView === 'journal') Render.view(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –∏–ª–∏ –∂—É—Ä–Ω–∞–ª
    }, error);

    state.usedTokensListener = usedTokensCol.onSnapshot(snapshot => {
      // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ (—Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤)
      const dayAgo = Date.now() - (24 * 60 * 60 * 1000);
      state.usedTokens = snapshot.docs
        .filter(doc => doc.data().timestamp > dayAgo)
        .map(doc => doc.id);
      log('Used tokens updated from Firebase:', state.usedTokens.length);
    }, error);

    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('t');

    if (token) {
      state.currentView = 'register';
      log('Token in URL, showing registration');
    } else {
      state.currentView = 'admin';

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —Ç–æ–∫–µ–Ω –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫—ç—à–∞
      const savedToken = localCache.get('currentToken');
      const savedExpiry = localCache.get('tokenExpiry');

      if (savedToken && savedExpiry && savedExpiry > Date.now()) {
        state.currentToken = savedToken;
        state.tokenExpiry = savedExpiry;
        log('Restored token:', savedToken);
        TokenManager.startTimers();
      } else {
        TokenManager.create();
      }
    }

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
    window.App = App;

    // –†–µ–Ω–¥–µ—Ä–∏–º
    Render.view();
  }

  // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
</body>
</html>

